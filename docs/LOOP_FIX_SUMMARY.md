# Loop åŠŸèƒ½ä¿®å¤æ€»ç»“

## ğŸ› å‘ç°çš„é—®é¢˜

### 1. Loop é€‰æ‹©èœå•æ˜¾ç¤º"This interaction failed"

**åŸå› **ï¼š

- Discord äº¤äº’å¿…é¡»åœ¨ 3 ç§’å†…å“åº”
- ä»£ç æ²¡æœ‰ä½¿ç”¨`deferReply()`æ¥å»¶è¿Ÿå“åº”
- å³ä½¿æ“ä½œæˆåŠŸï¼Œç”¨æˆ·ä¹Ÿä¼šçœ‹åˆ°è¶…æ—¶é”™è¯¯

**ä¿®å¤**ï¼š

```javascript
// ä¿®å¤å‰
await interaction.reply({
  embeds: [successEmbed],
  ephemeral: true,
});

// ä¿®å¤å
await interaction.deferReply({ ephemeral: true });
// ... å¤„ç†é€»è¾‘ ...
await interaction.editReply({
  embeds: [successEmbed],
});
```

### 2. Bot åœ¨å‡ æ¬¡ loop ååœæ­¢æ’­æ”¾

**åŸå› **ï¼š

- `retryCurrentTrack()`ä¼šå¢åŠ `retryCount`
- è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ï¼ˆ2 æ¬¡ï¼‰åä¼šè°ƒç”¨`handleTrackEnd()`
- åœ¨ track loop æ¨¡å¼ä¸‹ï¼Œè¿™ä¼šå¯¼è‡´å¾ªç¯è¢«ä¸­æ–­

**ä¿®å¤**ï¼š

```javascript
// åœ¨handleTrackEndä¸­é‡ç½®retryè®¡æ•°
if (this.loopMode === "track" && this.currentTrack) {
  this.currentTrack.retryCount = 0; // é‡ç½®é‡è¯•æ¬¡æ•°
  await this.playCurrentTrack();
}

// åœ¨idleå¤„ç†ä¸­ï¼Œå¦‚æœæ˜¯track loopæ¨¡å¼ï¼Œä¸è®¡å…¥retryæ¬¡æ•°
if (this.loopMode === "track") {
  this.currentTrack.retryCount = 0;
}
```

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### Discord äº¤äº’ç”Ÿå‘½å‘¨æœŸ

1. ç”¨æˆ·ç‚¹å‡»æŒ‰é’®/é€‰æ‹©èœå•
2. Bot å¿…é¡»åœ¨**3 ç§’å†…**å“åº”
3. ä½¿ç”¨`deferReply()`å¯ä»¥å»¶é•¿å“åº”æ—¶é—´åˆ°**15 åˆ†é’Ÿ**
4. ä½¿ç”¨`editReply()`æ›´æ–°å»¶è¿Ÿçš„å“åº”

### Loop æ¨¡å¼å·¥ä½œåŸç†

- **None**: æ’­æ”¾å®Œé˜Ÿåˆ—ååœæ­¢
- **Queue**: æ’­æ”¾åˆ°æœ€åä¸€é¦–åè¿”å›ç¬¬ä¸€é¦–
- **Track**: é‡å¤æ’­æ”¾å½“å‰æ›²ç›®

### é‡è¯•æœºåˆ¶ä¸ Loop çš„å†²çª

- é‡è¯•æœºåˆ¶ç”¨äºå¤„ç†çŸ­æš‚çš„æ’­æ”¾å¤±è´¥
- ä½†åœ¨ loop æ¨¡å¼ä¸‹ï¼Œé‡è¯•è®¡æ•°ä¸åº”è¯¥ç´¯ç§¯
- ç°åœ¨ track loop æ¨¡å¼ä¼šé‡ç½®é‡è¯•è®¡æ•°

## âœ… ä¿®å¤åçš„è¡Œä¸º

1. **Loop é€‰æ‹©ç«‹å³ç”Ÿæ•ˆ**

   - ç”¨æˆ·é€‰æ‹© loop æ¨¡å¼åç«‹å³çœ‹åˆ°æˆåŠŸæ¶ˆæ¯
   - ä¸å†æ˜¾ç¤º"interaction failed"é”™è¯¯

2. **Track Loop æ— é™å¾ªç¯**

   - å•æ›²å¾ªç¯ä¸å†å› é‡è¯•æ¬¡æ•°è€Œä¸­æ–­
   - æ­£å¸¸æ’­æ”¾ç»“æŸåè‡ªåŠ¨é‡æ–°å¼€å§‹

3. **Queue Loop æ­£ç¡®å¾ªç¯**
   - æ’­æ”¾åˆ°æœ€åä¸€é¦–åè‡ªåŠ¨è¿”å›ç¬¬ä¸€é¦–
   - ä¿æŒæ’­æ”¾é¡ºåº

## ğŸ§ª æµ‹è¯•éªŒè¯

è¿è¡Œä»¥ä¸‹æµ‹è¯•ç¡®ä¿ä¿®å¤æœ‰æ•ˆï¼š

```bash
# æµ‹è¯•loopæ¨¡å¼é€»è¾‘
node tests/manual/test-loop-mode.js

# è¿è¡Œå®Œæ•´é›†æˆæµ‹è¯•
node tests/integration/test-all-features.js
```

## ğŸ“ åç»­æ”¹è¿›å»ºè®®

1. **æ·»åŠ  Loop çŠ¶æ€æŒ‡ç¤ºå™¨**

   - åœ¨ now playing åµŒå…¥ä¸­æ˜¾ç¤ºå½“å‰ loop æ¨¡å¼
   - åœ¨æŒ‰é’®ä¸Šæ˜¾ç¤ºä¸åŒçš„ emoji è¡¨ç¤º loop çŠ¶æ€

2. **Loop è®¡æ•°å™¨**

   - æ˜¾ç¤ºå½“å‰æ›²ç›®å·²å¾ªç¯æ¬¡æ•°
   - åœ¨ queue loop ä¸­æ˜¾ç¤ºå·²å®Œæ•´å¾ªç¯é˜Ÿåˆ—çš„æ¬¡æ•°

3. **æ™ºèƒ½é‡è¯•**
   - åŒºåˆ†ç½‘ç»œé”™è¯¯å’Œæ’­æ”¾ç»“æŸ
   - å¯¹ä¸åŒé”™è¯¯ç±»å‹é‡‡ç”¨ä¸åŒçš„é‡è¯•ç­–ç•¥

