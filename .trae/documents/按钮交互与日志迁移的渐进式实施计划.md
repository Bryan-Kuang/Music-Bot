## 关键修正点
- 事件驱动纯化：交互层不再手动触发 UI 刷新或 notify，所有 UI 更新仅由 PlayerControl 的事件 → InterfaceUpdater 完成。
- Slash 命令同步迁移：/pause、/resume、/skip、/prev、/stop 与按钮同样走 PlayerControl；/play 走 PlaylistManager.add + PlayerControl.play。
- 交互应答策略：按钮统一 `await interaction.deferUpdate()`；命令统一 `await interaction.reply({ content: '执行中...', ephemeral: true })` 或 `deferReply`。

## 步骤零：全局装配
- 在 `src/bot/client.js` 启动完成后：
  - `PlayerControl.initialize(AudioManager)`
  - `PlaylistManager.initialize(AudioManager)`
  - `InterfaceUpdater.setClient(this.client)`
  - `InterfaceUpdater.bind(PlayerControl)`
- 验证：启动无错误日志；无重复监听器。

## 步骤一：交互层迁移（按钮与命令）
- 文件：`src/bot/events/interactionCreate.js`
  - 在 `handleButtonInteraction` 中：
    - 对 `pause_resume/skip/prev/stop`：
      - `await interaction.deferUpdate()`
      - `InterfaceUpdater.setPlaybackContext(guildId, interaction.channelId)`
      - 仅调用 `PlayerControl.*(guildId)`；不做任何 UI 编辑与 notify。
      - 错误捕获写 `logger_service.error('Button interaction failed', { customId, error })`。
- 文件：`src/bot/commands/*.js`
  - `/pause`、`/resume`、`/skip`、`/prev`、`/stop`：
    - `await interaction.reply({ content: '执行中...', ephemeral: true })`
    - `InterfaceUpdater.setPlaybackContext(guildId, interaction.channelId)`
    - 仅调用 `PlayerControl.*(guildId)`；成功后可 `editReply('操作已完成')`；不编辑播放消息。
  - `/play`：
    - 校验频道与 URL → `joinVoiceChannel`
    - `await PlaylistManager.add(guildId, url, requestedBy)`
    - 如未播放：`await PlayerControl.play(guildId)`；不手动操作 UI；保持 `ephemeral` 文本提示。
- 验证：实际点击按钮后按钮停止转圈，Embed 在 1 秒内自动变化；命令可正常反馈文本并触发播放。

## 步骤二：日志服务替换
- 全局替换 `require('../utils/logger')` → `require('../logger_service')`。
- 统一日志格式：`logger_service.info/warn/error(message, { context... })`。
- 验证：检查 `logs/error-YYYY-MM-DD.log` 与 `logs/app-YYYY-MM-DD.log` 行格式规范。

## 步骤三：结构重组与清理
- 清理废弃：移除 `buttons.js` 的处理器辅助（仅保留 UI 构建）；标注废弃 `utils/logger.js`。
- 目录建议（后移）：
  - `src/control/player_control.js`
  - `src/playlist/playlist_manager.js`
  - `src/services/logger_service.js`
  - `src/ui/interface_updater.js`
- 更新所有引用路径；通过 IDE/搜索验证无残留。

## 步骤四：质量保障
- 每步后运行 `npm test`；手测按钮与命令；检查日志。
- 关注交互应答 3 秒限制与 UI 更新的消息编辑/发送策略是否稳定。

## 步骤五：文档更新
- 更新 `docs/architecture.md`、`docs/structure.md` 与 `.trae/documents/重构播放控制、列表管理与日志系统.md`，记录：
  - 事件链路（PlayerControl → InterfaceUpdater → 消息编辑/发送）
  - 命令与按钮统一入口
  - 废弃接口与文件清单。

确认后将按此方案执行：先改交互层与命令、修日志引用、再做目录重组与清理，逐步验证。